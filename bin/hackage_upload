#!/bin/sh

set -eu

if [ "${1:-}" = "candidate" ]; then
  CANDIDATE="candidate"
  CANDIDATES="candidates"
else
  CANDIDATE=""
  CANDIDATES=""
fi

cabal sdist
PACKAGE=$(grep '^name:' *.cabal | awk '{print $2}')
VERSION=$(grep '^version:' *.cabal | awk '{print $2}')
curl --header "Authorization: X-ApiKey $API_TOKEN_HACKAGE" \
  -F "package=@dist-newstyle/sdist/$PACKAGE-$VERSION.tar.gz" \
  "https://hackage.haskell.org/packages$CANDIDATES"
curl --header "Authorization: X-ApiKey $API_TOKEN_HACKAGE" \
  -X PUT \
  -H "Content-Type: application/x-tar" \
  -H "Content-Encoding: gzip" \
  --data-binary "@dist-newstyle/$PACKAGE-$VERSION-docs.tar.gz" \
  "https://hackage.haskell.org/package/$PACKAGE-$VERSION$CANDIDATE/docs"
